---
- name: net-tools
  yum:
    name: net-tools
    state: present

- name: sysctl enable ipv4 forwarding and route all traffic through iptables 
  sysctl:
    name: net.ipv4.ip_forward
    value: 1
    state: present
    reload: yes

- name: sysctl enable ipv4 forwarding and route all traffic through iptables 
  sysctl:
    name: net.bridge.bridge-nf-call-iptables
    value: 1
    state: present
    reload: yes

# - name: sysctl enable ipv4 forwarding and route all traffic through iptables 
#   sysctl:
#     name: net.bridge.bridge-nf-call-ip6tables
#     value: 1
#     state: present
#     reload: yes

- name: remove swapfile from /etc/fstab
  mount:
    name: swap
    fstype: swap
    state: absent

- name: disable swap
  command: swapoff -a
  when: ansible_swaptotal_mb > 0

# sestatus to check
- name: disable selinux
  selinux:
    state: disabled

- name: kubernetes binaries
  copy:
    src: /vagrant/private/repo/kubernetes/server/bin/{{ item }}
    dest: /usr/bin/{{ item }}
    mode: 744
  with_items:
    - kubelet
    - kubectl

- name: kubernetes kube user
  user:
    name: kube

- name: kubernetes directories
  file:
    path: "{{ kubernetes_config_dir }}"
    state: directory
  with_items:
    - "{{ kubernetes_config_dir }}/manifests"
    - "{{ kubernetes_config_dir }}/pki"
    - "{{ kubernetes_srv_dir }}"
    - /var/lib/kubelet/pki
    - /etc/systemd/system/kubelet.service.d
    - /etc/cni/net.d
    - /opt/cni/bin

- name: kubelet systemd service file
  template:
    src: systemd/kubelet.service.j2
    dest: /etc/systemd/system/kubelet.service

- name: kubelet systemd environment file
  template:
    src: systemd/kubelet.conf.j2
    dest: /etc/systemd/system/kubelet.service/kubelet.conf

- name: kubeconfig files
  template:
    src: etc/{{ item }}.conf.j2
    dest: /etc/kubernetes/{{ item }}.conf
  with_items:
    - admin
    - controller-manager
    - kubelet
    - scheduler

# kube-proxy

# - name: cni 0.6.0 binaries
#   copy:
#     src: private/repo/cni-0.6.0/{{ item }}
#     dest: /opt/cni/bin/{{ item }}
#   with_items:
#     - bridge
#     - dhcp
#     - flannel
#     - host-local
#     - ipvlan
#     - loopback
#     - macvlan
#     - portmap
#     - ptp
#     - sample
#     - tuning
#     - vlan

# kubelet service