---
- name: root user .kube dir
  file:
    path: /root/.kube
    state: directory

- name: cluster admin kubeconfig file for root user
  template:
    src: etc/admin.config.j2
    dest: /root/.kube/config

- name: kubeconfig files
  template:
    src: etc/{{ item }}.config.j2
    dest: /etc/kubernetes/{{ item }}.config
  with_items:
    - controller-manager
    - scheduler

- name: kubelet manifests
  template:
    src: etc/manifests/{{ item }}.yml
    dest: "{{ kube_config_dir }}/manifests/{{ item }}.yml"
  with_items:
    - etcd
    - kube-apiserver
    - kube-controller-manager
    - kube-scheduler

- include: certs.yml

- name: flannel networking deployment file
  template:
    src: etc/net/flannel.yml
    dest: "{{ kube_config_dir }}/net/flannel.yml"
  notify: kubectl flannel
  when: inventory_hostname == kube_primary_master

- name: core-dns deployment file
  template:
    src: etc/net/core-dns.yml
    dest: "{{ kube_config_dir }}/net/core-dns.yml"
  notify: kubectl coreDNS
  when: inventory_hostname == kube_primary_master

- name: kubelet cluster role file
  copy:
    src: kube-apiserver-kubelet-cluster-role.yml
    dest: "{{ kube_config_dir }}/roles/kube-apiserver-kubelet-cluster-role.yml"
  notify: kubectl kubelet role
  when: inventory_hostname == kube_primary_master

- name: kubelet cluster role binding file
  copy:
    src: kube-apiserver-kubelet-cluster-rolebinding.yml
    dest: "{{ kube_config_dir }}/roles/kube-apiserver-kubelet-cluster-rolebinding.yml"
  notify: kubectl kubelet cluster role binding
  when: inventory_hostname == kube_primary_master

- name: kube-dashboard file
  template:
    src: kube-dashboard.yml
    dest: "{{ kube_config_dir }}/kube-dashboard.yml"
  notify: kubectl kube-dashboard
  when: inventory_hostname == kube_primary_master

- name: token auth file
  template:
    src: token-auth.csv
    dest: "{{ kube_config_dir }}/pki/token-auth.csv"

- name: wait for etcd port to become responsive
  wait_for:
    port: 2379
    delay: 10
    timeout: 700

- name: wait for apiserver port to become responsive
  wait_for:
    port: 6443

- name: wait for scheduler port to become responsive
  wait_for:
    port: 10251

- name: wait for controller manager port to become responsive
  wait_for:
    port: 10252

- name: pause 1 minute to allow leader elections to take place
  pause:
    minutes: 1
